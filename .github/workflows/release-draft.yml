name: PHP Release

on:
  push:
    branches:
      - main


jobs:
  draft-release:
    if: ${{ !github.event.pull_request.merged }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semver.outputs.VERSION }}
      changelog: ${{ steps.changelog.outputs.BODY }}
    steps:
      - name: Get latest release
        id: latest-release
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const { data } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              if (data.length === 0) return null;
              return data.sort((a, b) =>
                new Date(b.published_at) - new Date(a.published_at)
              )[0].tag_name;
            } catch (e) {
              return null;
            }

      - name: Parse current version
        id: version-parse
        shell: bash
        run: |
          TAG="${{ steps.latest-release.outputs.result }}"

          # If no releases (TAG empty or "null") ‚Üí start from 0.0.1
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "MAJOR=0" >> $GITHUB_OUTPUT
            echo "MINOR=0" >> $GITHUB_OUTPUT
            echo "PATCH=1" >> $GITHUB_OUTPUT
          # If tag matches X.Y.Z or vX.Y.Z ‚Üí parse components
          elif [[ "$TAG" =~ ^v?([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "MAJOR=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "MINOR=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
            echo "PATCH=${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
          else
            # Unknown format ‚Üí start from 0.0.1
            echo "MAJOR=0" >> $GITHUB_OUTPUT
            echo "MINOR=0" >> $GITHUB_OUTPUT
            echo "PATCH=1" >> $GITHUB_OUTPUT
          fi

      - name: Determine SemVer bump (PHP-specific labels)
        id: semver
        shell: bash
        run: |
          MAJOR=${{ steps.version-parse.outputs.MAJOR }}
          MINOR=${{ steps.version-parse.outputs.MINOR }}
          PATCH=${{ steps.version-parse.outputs.PATCH }}

          LABELS='${{ join(github.event.pull_request.labels.*.name,  ' ') }}'
          LOWER_LABELS=$(echo "$LABELS" | tr '[:upper:]' '[:lower:]')

          # Groups of labels by SemVer categories (PHP-focused)
          MAJOR_LABELS='break|breaking|major|deprecated|refactor|api-change|bc-break|downgrade|legacy'
          MINOR_LABELS='feature|enhancement|new|add|implement|psr-[0-9]+|standards|coding-style|php[0-9]+\.[0-9]+|dependency-update|interface|trait|enum'
          PATCH_LABELS='fix|bug|patch|hotfix|security|vulnerability|test|coverage|performance|optimization|ci|cd|docs|documentation|changelog|readme|lint|format|typo'

          if echo "$LOWER_LABELS" | grep -Eiq "$MAJOR_LABELS"; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
          elif echo "$LOWER_LABELS" | grep -Eiq "$MINOR_LABELS"; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
          elif echo "$LOWER_LABELS" | grep -Eiq "$PATCH_LABELS"; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
          else
            # Default: patch bump
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
          fi

          VERSION="${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "SHORT=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        shell: bash
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          PR_TITLE='${{ github.event.pull_request.title }}'
          PR_URL='${{ github.event.pull_request.html_url }}'
          AUTHOR='${{ github.event.pull_request.user.login }}'
          LABELS_STR='${{ join(github.event.pull_request.labels.*.name, ' . ') }}'
          VERSION=${{ steps.semver.outputs.VERSION }}

          cat > changelog.md <<EOF
          
          ## Release ${VERSION}

          > üõ† Auto‚Äëgenerated draft for PHP project. Review before publishing.

          ### PR Overview
          - **Title**: [${PR_TITLE}](${PR_URL})
          - **Number**: #${PR_NUM}
          - **Author**: @${AUTHOR}
          - **Labels**: ${LABELS_STR}

          ### Change Categories
          $( 
            LOWER_LABELS="$(echo "${LABELS_STR}" | tr '[:upper:]' '[:lower:]')"
            if echo "$LOWER_LABELS" | grep -iq 'feature'; then
              echo "- ‚ú® Features"
            fi
            if echo "$LOWER_LABELS" | grep -Eiq 'fix|bug|hotfix|security'; then
              echo "- üêû Bug Fixes & Security"
            fi
            if echo "$LOWER_LABELS" | grep -Eiq 'refactor|deprecated|api-change'; then
              echo "- ‚öí Refactoring & Deprecations"
            fi
            if echo "$LOWER_LABELS" | grep -Eiq 'test|coverage'; then
              echo "- üß™ Tests & Coverage"
            fi
            if echo "$LOWER_LABELS" | grep -Eiq 'docs|readme|changelog'; then
              echo "- üìù Documentation"
            fi
            if echo "$LOWER_LABELS" | grep -Eiq 'performance|optimization'; then
              echo "- üöÄ Performance"
            fi
            if echo "$LOWER_LABELS" | grep -Eiq 'ci|cd'; then
              echo "- üîß CI/CD Improvements"
            fi
            if echo "$LOWER_LABELS" | grep -Eiq 'psr'; then
              echo "- üìè PSR Standards"
            fi
            if echo "$LOWER_LABELS" | grep -Eiq 'php[0-9]+\.[0-9]+'; then
              echo "- üåê PHP Version Support"
            fi
          )

          ### Details
          - ${PR_TITLE} ([#${PR_NUM}](${PR_URL}))

          ---
          _Generated: $(date +'%Y-%m-%d %H:%M')
          EOF

          # Expose changelog body as a multiline output
          echo "BODY<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Create/Update Release Draft
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.semver.outputs.VERSION }}
          name: Release ${{ steps.semver.outputs.SHORT }}
          body: ${{ steps.changelog.outputs.BODY }}
          draft: true
          prerelease: false